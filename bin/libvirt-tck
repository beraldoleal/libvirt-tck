#!/usr/bin/perl
# -*- perl -*-

use strict;
use warnings;

use Getopt::Long;
use Sys::Hostname;
use App::Prove;

my $datadir = "/usr/share/libvirt-tck";
my $confdir = "/etc/libvirt-tck";

my $host = hostname();


use Getopt::Long;

my $verbose = 0;
my $format = "text";
my $testdir = "$datadir/tests";
my $archive;

GetOptions("verbose" => \$verbose,
	   "archive=s" => \$archive,
	   "format=s" => \$format,
           "testdir=s" => \$testdir);

sub help {
    print "syntax: $0 CONFNAME\n";
    exit 1;
}

my $conf = shift @ARGV;

&help unless $conf;

my $conffile;
if (-f "$conf.cfg") {
    $conffile = "$conf.cfg";
} elsif (-f "./conf/$conf.cfg") {
    $conffile = "./conf/$conf.cfg"
} else {
    $conffile = "$confdir/$conf.cfg";
    unless (-f "$conffile") {
	print STDERR "config file $conffile does not exist\n";
	exit 2;
    }
}

my @newargv = ("-r", "--norc", "--merge", $testdir);

if ($archive) {
    push @newargv, "-a", $archive;
}

if ($verbose) {
    push @newargv, "-v";
} elsif ($format ne "text") {
    push @newargv, "-m", "-Q";
}

if ($format eq "xml") {
    push @newargv, "--formatter=Sys::Virt::TCK::TAP::XMLFormatter";
}

if ($format eq "html") {
    push @newargv, "--formatter=TAP::Formatter::HTML"
}


$ENV{LIBVIRT_TCK_CONFIG} = $conffile;

my $app = App::Prove->new;
$app->process_args(@newargv);
exit ($app->run ? 0 : 1);
